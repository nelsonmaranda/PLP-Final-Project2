import{u as pe,b as fe,a as i,j as e}from"./index-ByvNfErA.js";import{r as l}from"./vendor-BKU87Gzz.js";import{L as h}from"./router-Z6rqMkFf.js";import{U as C,x as he,e as k,d as P,B as ge,A as ye,y as be,z as je,X as Z,R as S,M as ve,g as ee,k as se}from"./icons-BSDC5w2I.js";function Ie(){var B,K,H,W,O,X,Y,G,J,Q,V;const{t}=pe(),{state:a,setUser:m}=fe(),[d,ae]=l.useState("profile"),[g,y]=l.useState(!1),[_,E]=l.useState(!1),[F,b]=l.useState(null),[te,j]=l.useState(!1),[v,re]=l.useState({displayName:((B=a.user)==null?void 0:B.displayName)||"",email:((K=a.user)==null?void 0:K.email)||""}),[L,p]=l.useState(!1),[A,c]=l.useState(((H=a.user)==null?void 0:H.avatarUrl)||null);l.useEffect(()=>{var s;(s=a.user)!=null&&s.avatarUrl&&c(a.user.avatarUrl)},[(W=a.user)==null?void 0:W.avatarUrl]);const[T,le]=l.useState([]),[N,$]=l.useState(!1),[D,oe]=l.useState([]),[w,M]=l.useState(!1),R=l.useRef(!1),[x,ie]=l.useState({totalReports:0,reportsThisMonth:0,favoriteRoutesCount:0,averageRating:0,mostReportedRoute:null}),U=l.useCallback(async()=>{if(a.user){$(!0);try{console.log("Loading reports for user:",a.user._id);const s=await i.getUserReports(a.user._id);console.log("Reports response:",s),s.success&&s.data?(console.log("Reports data:",s.data.reports),le(s.data.reports||[])):console.log("Reports response failed:",s)}catch(s){console.error("Error loading reports:",s)}finally{$(!1)}}},[(O=a.user)==null?void 0:O._id]),u=l.useCallback(async()=>{if(a.user){if(R.current){console.log("Favorites already loading, skipping...");return}console.log("Setting favorites loading to true"),R.current=!0,M(!0);try{console.log("Loading favorites for user:",a.user._id);const s=await i.getFavoriteRoutes(a.user._id);console.log("Favorites response:",s),s.success&&s.data?(console.log("Favorites data:",s.data.routes),oe(s.data.routes||[])):console.log("Favorites response failed:",s)}catch(s){console.error("Error loading favorites:",s)}finally{console.log("Setting favorites loading to false"),R.current=!1,M(!1)}}},[(X=a.user)==null?void 0:X._id]),I=l.useCallback(async()=>{if(a.user)try{console.log("Loading analytics for user:",a.user._id);const s=await i.getUserAnalytics(a.user._id);console.log("Analytics response:",s),s.success&&s.data?(console.log("Analytics data:",s.data),ie(s.data)):console.log("Analytics response failed:",s)}catch(s){console.error("Error loading analytics:",s)}},[(Y=a.user)==null?void 0:Y._id]),ne=l.useCallback(async s=>{if(a.user)try{(await i.removeFavoriteRoute(a.user._id,s)).success&&u()}catch(r){console.error("Error removing favorite:",r)}},[(G=a.user)==null?void 0:G._id]),ce=l.useCallback(async()=>{if(!a.user){console.log("No user found, skipping photo load");return}try{console.log("Loading profile photo for user:",a.user._id);const s=await i.getUserPhoto(a.user._id);console.log("Photo API response:",s),s.success&&s.data?(console.log("Profile photo loaded successfully:",s.data.url.substring(0,50)+"..."),c(s.data.url),m({...a.user,avatarUrl:s.data.url})):(console.log("No profile photo found in response:",s),a.user.avatarUrl&&!a.user.avatarUrl.startsWith("blob:")?(console.log("Using existing avatarUrl from user state:",a.user.avatarUrl.substring(0,50)+"..."),c(a.user.avatarUrl)):(console.log("No valid avatarUrl found, using default avatar"),c("")))}catch(s){console.log("Error loading profile photo:",s),a.user.avatarUrl&&!a.user.avatarUrl.startsWith("blob:")?(console.log("Using fallback avatarUrl from user state:",a.user.avatarUrl.substring(0,50)+"..."),c(a.user.avatarUrl)):(console.log("No valid fallback avatarUrl, using default avatar"),c(""))}},[(J=a.user)==null?void 0:J._id,m]);l.useEffect(()=>{a.user&&(ce(),U(),u(),I())},[(Q=a.user)==null?void 0:Q._id]),l.useEffect(()=>{if(a.user)switch(d){case"reports":U();break;case"favorites":u();break;case"analytics":I();break}},[d,(V=a.user)==null?void 0:V._id]);const de=async s=>{if(s.preventDefault(),!!a.user){E(!0),b(null),j(!1);try{const r=await i.updateProfile(a.user._id,v);r.success&&r.data?(m(r.data.user),j(!0),y(!1),setTimeout(()=>j(!1),3e3)):b(t("profile.updateError"))}catch(r){console.error("Profile update error:",r),b(t("profile.updateError"))}finally{E(!1)}}},me=async s=>{var n;if(!s.target.files||s.target.files.length===0)return;const r=s.target.files[0];try{p(!0);const o=await i.uploadFile(r,"profile");if(console.log("Upload response:",o),o!=null&&o.success&&((n=o==null?void 0:o.data)!=null&&n.url)){const f=o.data.url;console.log("Photo uploaded successfully, URL:",f.substring(0,50)+"..."),c(f),await i.updateProfile(a.user._id,{displayName:a.user.displayName,email:a.user.email,avatarUrl:f}),m({...a.user,avatarUrl:f}),console.log("Profile updated with uploaded photo URL")}else console.error("Upload failed or invalid response:",o),alert("Failed to upload photo. Please try again.")}catch(o){console.error("Photo upload failed:",o),alert("Failed to upload photo. Please try again.")}finally{p(!1)}},z=async s=>{try{p(!0),c(s),await i.updateProfile(a.user._id,{displayName:a.user.displayName,email:a.user.email,avatarUrl:s}),m({...a.user,avatarUrl:s})}catch(r){console.error("Avatar URL update failed",r)}finally{p(!1)}},q=s=>{const{name:r,value:n}=s.target;re(o=>({...o,[r]:n}))},xe=s=>new Date(s).toLocaleDateString("en-KE",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),ue=s=>{switch(s){case"low":return"text-green-600 bg-green-100";case"medium":return"text-yellow-600 bg-yellow-100";case"high":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}};return a.user?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"px-6 py-8",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full overflow-hidden bg-primary-500 flex items-center justify-center",children:A?e.jsx("img",{src:A,alt:"Avatar",className:"w-16 h-16 object-cover"}):e.jsx(C,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:a.user.displayName}),e.jsx("p",{className:"text-gray-600",children:a.user.email}),e.jsxs("p",{className:"text-sm text-gray-500 capitalize",children:[t("profile.role"),": ",t(`roles.${a.user.role}`)]})]}),e.jsxs("button",{onClick:()=>y(!g),className:"btn btn-ghost btn-sm",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),t(g?"common.cancel":"profile.personalInfo.editProfile")]}),e.jsxs("div",{className:"ml-4 flex flex-col space-y-2",children:[e.jsxs("label",{className:"btn btn-outline btn-sm cursor-pointer",children:[t(L?"profile.personalInfo.uploading":"profile.personalInfo.uploadPhoto"),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:me})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"url",placeholder:t("profile.personalInfo.orEnterImageUrl"),className:"px-2 py-1 text-xs border rounded w-48",onKeyPress:s=>{if(s.key==="Enter"){const r=s.target;r.value&&(z(r.value),r.value="")}}}),e.jsx("button",{onClick:s=>{const r=s.currentTarget.previousElementSibling;r!=null&&r.value&&(z(r.value),r.value="")},className:"btn btn-ghost btn-xs",disabled:L,children:t("profile.personalInfo.set")}),e.jsx("button",{onClick:async()=>{if(a.user)try{(await i.deleteUserPhoto(a.user._id)).success&&(c(""),m({...a.user,avatarUrl:""}),alert("Profile photo deleted successfully"))}catch(s){console.error("Error deleting photo:",s),alert("Failed to delete photo")}},className:"px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:t("profile.personalInfo.deletePhoto")})]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",children:[{id:"profile",name:t("profile.tabs.personal"),icon:C},{id:"reports",name:t("profile.tabs.reports"),icon:k},{id:"favorites",name:t("profile.tabs.favorites"),icon:P},{id:"analytics",name:t("profile.tabs.analytics"),icon:ge}].map(s=>{const r=s.icon;return e.jsxs("button",{onClick:()=>ae(s.id),className:`py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${d===s.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(r,{className:"w-4 h-4"}),e.jsx("span",{children:s.name})]},s.id)})})}),e.jsxs("div",{className:"p-6",children:[d==="profile"&&e.jsx("div",{children:g?e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[F&&e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"h-5 w-5 text-red-400 mr-2"}),e.jsx("p",{className:"text-sm text-red-800",children:F})]})}),te&&e.jsx("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(be,{className:"h-5 w-5 text-green-400 mr-2"}),e.jsx("p",{className:"text-sm text-green-800",children:"Profile updated successfully!"})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"displayName",className:"block text-sm font-medium text-gray-700 mb-1",children:t("profile.personalInfo.displayName")}),e.jsx("input",{type:"text",id:"displayName",name:"displayName",value:v.displayName,onChange:q,className:"input w-full",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:t("profile.personalInfo.email")}),e.jsx("input",{type:"email",id:"email",name:"email",value:v.email,onChange:q,className:"input w-full",required:!0})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:_,className:"btn btn-primary",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Save Changes"]})}),e.jsxs("button",{type:"button",onClick:()=>y(!1),className:"btn btn-ghost",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Cancel"]})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:t("profile.accountInformation")}),e.jsxs("dl",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("profile.personalInfo.displayName")}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:a.user.displayName})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("profile.personalInfo.email")}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:a.user.email})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("profile.accountType")}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 capitalize",children:t(`roles.${a.user.role}`)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("profile.memberSince")}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:new Date(a.user.createdAt||Date.now()).toLocaleDateString("en-KE")})]})]})]})})}),d==="reports"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:t("profile.myTripReports")}),e.jsxs("button",{onClick:U,disabled:N,className:"flex items-center space-x-2 px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 disabled:opacity-50",children:[e.jsx(S,{className:`w-4 h-4 ${N?"animate-spin":""}`}),e.jsx("span",{children:t("profile.refresh")})]})]}),N?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"})}):T.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(k,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:t("profile.noReportsYet")}),e.jsx(h,{to:"/report",className:"btn btn-primary",children:t("profile.submitFirstReport")})]}):e.jsx("div",{className:"space-y-4",children:T.map(s=>{var r,n;return e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.status==="resolved"?"bg-green-100 text-green-800":s.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:s.status})}),e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ve,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:typeof s.routeId=="object"&&((r=s.routeId)!=null&&r.name)?`${s.routeId.name} (${s.routeId.routeNumber})`:`Route ${s.routeId}`}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${ue(s.severity)}`,children:s.severity})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center space-x-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{className:"w-3 h-3 mr-1"}),xe(s.createdAt)]}),e.jsxs("span",{className:"capitalize",children:["Type: ",s.reportType]}),typeof s.routeId=="object"&&((n=s.routeId)==null?void 0:n.operator)&&e.jsxs("span",{className:"text-blue-600",children:["Operator: ",s.routeId.operator]})]})]})})},s._id)})})]}),d==="favorites"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:t("profile.ratedRoutes")}),e.jsxs("button",{onClick:u,disabled:w,className:"flex items-center space-x-2 px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 disabled:opacity-50",children:[e.jsx(S,{className:`w-4 h-4 ${w?"animate-spin":""}`}),e.jsx("span",{children:t("profile.refresh")})]})]}),w?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"})}):D.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(P,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:t("profile.noRatedRoutes")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 justify-center",children:[e.jsx("input",{type:"text",placeholder:"Enter Route ID to rate",className:"px-3 py-2 border rounded-lg w-64",id:"routeIdInput"}),e.jsx("button",{onClick:async()=>{var n;const s=document.getElementById("routeIdInput"),r=(n=s==null?void 0:s.value)==null?void 0:n.trim();if(r&&a.user)try{(await i.addFavoriteRoute(a.user._id,r)).success&&(u(),s.value="")}catch(o){console.error("Error adding favorite:",o)}},className:"btn btn-primary btn-sm",children:"Rate"})]}),e.jsx(h,{to:"/map",className:"btn btn-primary",children:t("profile.exploreRoutes")})]})]}):e.jsx("div",{className:"space-y-4",children:D.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:s.name}),e.jsx("span",{className:"px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full",children:t("profile.personalInfo.rated")})]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.operator}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Route ",s.routeNumber]}),e.jsxs("div",{className:"flex items-center space-x-1 mt-2",children:[e.jsx(se,{className:"w-4 h-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm text-gray-600",children:t("profile.personalInfo.youRatedThisRoute")})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{to:`/map?route=${s._id}`,className:"btn btn-ghost btn-sm",children:t("profile.personalInfo.view")}),e.jsx("button",{onClick:()=>ne(s._id),className:"btn btn-ghost btn-sm text-red-600 hover:text-red-700",children:e.jsx(Z,{className:"w-4 h-4"})})]})]})},s._id))})]}),d==="analytics"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:t("profile.yourAnalytics")}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("button",{onClick:I,className:"flex items-center space-x-2 px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200",children:[e.jsx(S,{className:"w-4 h-4"}),e.jsx("span",{children:t("profile.refresh")})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(k,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:t("profile.totalReports")}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:x.totalReports})]})]})}),e.jsx("div",{className:"bg-green-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:t("profile.thisMonth")}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:x.reportsThisMonth})]})]})}),e.jsx("div",{className:"bg-purple-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:t("profile.favorites")}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:x.favoriteRoutesCount})]})]})}),e.jsx("div",{className:"bg-yellow-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-yellow-600",children:t("profile.avgRating")}),e.jsx("p",{className:"text-2xl font-bold text-yellow-900",children:x.averageRating.toFixed(1)})]})]})})]}),x.mostReportedRoute&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:t("profile.personalInfo.mostReportedRoute")}),e.jsx("p",{className:"text-sm text-gray-600",children:x.mostReportedRoute})]})]})]})]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(C,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:t("profile.pleaseLogin")}),e.jsx("p",{className:"text-gray-600 mb-4",children:t("profile.loginRequired")}),e.jsx(h,{to:"/login",className:"btn btn-primary",children:t("profile.goToLogin")})]})})}export{Ie as default};
//# sourceMappingURL=Profile-CbRIeswA.js.map
