var U=Object.defineProperty;var V=(a,r,t)=>r in a?U(a,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[r]=t;var D=(a,r,t)=>V(a,typeof r!="symbol"?r+"":r,t);import{a as H,j as e,L as I}from"./index-CizrQSfD.js";import{r as l}from"./vendor-BKU87Gzz.js";import{M as W,T as q,P as B,a as J,L as R,b as G}from"./leaflet-DyOFlehG.js";import{g as Q,F as K,L as X,f as O,e as z,C as Y,M as Z}from"./icons-erGNcDpK.js";import"./router-hf4IkB-x.js";class ee{constructor(){D(this,"cache",new Map)}set(r,t,d){const f=Date.now();this.cache.set(r,{data:t,timestamp:f,expiresAt:f+d})}get(r){const t=this.cache.get(r);return t?Date.now()>t.expiresAt?(this.cache.delete(r),null):t.data:null}clear(){this.cache.clear()}delete(r){this.cache.delete(r)}}const C=new ee;function se(a,r=[],t={}){const{debounceMs:d=300,cacheTime:f=5*60*1e3,retryAttempts:k=3,retryDelay:p=1e3}=t,[F,j]=l.useState(null),[M,y]=l.useState(!1),[E,b]=l.useState(null),[g,v]=l.useState(0),m=l.useRef(),x=l.useRef(),h=JSON.stringify(r),u=l.useCallback(async(i=!1)=>{const n=C.get(h);if(n&&!i){j(n);return}x.current&&x.current.abort(),x.current=new AbortController;try{y(!0),b(null);const c=await a();C.set(h,c,f),j(c),v(0)}catch(c){const o=c;if(o.name==="AbortError")return;b(o),g<k&&(v(N=>N+1),setTimeout(()=>{u(!0)},p*Math.pow(2,g)))}finally{y(!1)}},[a,h,f,k,p,g]),w=l.useCallback(()=>{m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{u()},d)},[u,d]);l.useEffect(()=>(w(),()=>{m.current&&clearTimeout(m.current),x.current&&x.current.abort()}),[w]);const A=l.useCallback(()=>{C.delete(h),u()},[h,u]),s=l.useCallback(()=>{C.clear()},[]);return{data:F,loading:M,error:E,retryCount:g,refetch:A,clearCache:s}}function T(a,r){let t=null;return(...d)=>{t&&clearTimeout(t),t=setTimeout(()=>{a(...d)},r)}}const P=R.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});typeof R<"u"&&R.Marker&&(R.Marker.prototype.options.icon=P);function ne(){var g,v,m,x,h,u,w,A;const[a,r]=l.useState(null),[t,d]=l.useState({highReliability:!0,safeRoutes:!0,lowFare:!1}),f=[-1.2921,36.8219],k=l.useCallback(async()=>{const s=await H.getRoutes({page:1,limit:50,sort:"createdAt",order:"desc"});return s.success&&s.data?await Promise.all(s.data.routes.map(async n=>{var c;try{const o=await H.getScoresByRoute(n._id);return{...n,score:(c=o.data)==null?void 0:c.score}}catch{return n}})):[]},[]),{data:p,loading:F,error:j,refetch:M}=se(k,[t],{debounceMs:500,cacheTime:2*60*1e3,retryAttempts:2}),y=(p||[]).filter(s=>!(t.highReliability&&(!s.score||s.score.reliability<4)||t.safeRoutes&&(!s.score||s.score.safety<4)||t.lowFare&&s.fare>=50)),E=s=>s>=4.5?"#22c55e":s>=3.5?"#f59e0b":s>=2.5?"#f97316":"#ef4444",b=s=>s.score?E(s.score.overall):"#3b82f6";return F?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(I,{}),e.jsx("p",{className:"text-gray-600 mt-4",children:"Loading routes..."})]})}):j?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Q,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("p",{className:"text-red-600 mb-4",children:(j==null?void 0:j.message)||"An error occurred"}),e.jsx("button",{onClick:M,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Try Again"})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"container py-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"card-title",children:"Nairobi Matatu Routes"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{className:"btn btn-outline btn-sm","aria-label":"Filter routes",children:[e.jsx(K,{className:"w-4 h-4 mr-2","aria-hidden":"true"}),"Filter"]}),e.jsxs("button",{className:"btn btn-outline btn-sm","aria-label":"View route list",children:[e.jsx(X,{className:"w-4 h-4 mr-2","aria-hidden":"true"}),"List"]})]})]})}),e.jsx("div",{className:"card-content p-0",children:e.jsx("div",{className:"map-container h-96",role:"img","aria-label":"Interactive map showing Nairobi matatu routes",children:e.jsxs(W,{center:f,zoom:11,style:{height:"100%",width:"100%"},children:[e.jsx(q,{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),y.map(s=>e.jsxs("div",{children:[e.jsx(B,{positions:s.path,color:b(s),weight:(a==null?void 0:a._id)===s._id?6:4,opacity:(a==null?void 0:a._id)===s._id?.8:.6}),s.stops.map((i,n)=>{var c,o,N,S;return e.jsx(J,{position:i.coordinates,icon:P,children:e.jsx(G,{children:e.jsxs("div",{className:"p-2",children:[e.jsx("h3",{className:"font-semibold",children:i.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.operator}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"h-3 w-3 mr-1 text-yellow-400"}),((o=(c=s.score)==null?void 0:c.overall)==null?void 0:o.toFixed(1))||"N/A"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),((S=(N=s.score)==null?void 0:N.safety)==null?void 0:S.toFixed(1))||"N/A"]}),e.jsxs("div",{className:"text-gray-600",children:[s.fare," KES"]})]})]})})},n)})]},s._id))]})})})]})}),e.jsxs("div",{className:"w-full lg:w-80",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Available Routes"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[y.length," of ",(p==null?void 0:p.length)||0," routes"]})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-4 w-4 text-gray-500","aria-hidden":"true"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Filters"})]}),e.jsxs("fieldset",{className:"space-y-2",children:[e.jsx("legend",{className:"sr-only",children:"Route filters"}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:t.highReliability,onChange:T(s=>d(i=>({...i,highReliability:s.target.checked})),300),"aria-describedby":"high-reliability-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"High Reliability (4+ stars)"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:t.safeRoutes,onChange:T(s=>d(i=>({...i,safeRoutes:s.target.checked})),300),"aria-describedby":"safe-routes-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Safe Routes (4+ stars)"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:t.lowFare,onChange:T(s=>d(i=>({...i,lowFare:s.target.checked})),300),"aria-describedby":"low-fare-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Low Fare (Under 50 KES)"})]})]})]})}),e.jsx("div",{className:"card-content p-0",children:e.jsx("div",{className:"divide-y divide-gray-200",children:y.map(s=>{var i,n,c,o,N,S,_,$;return e.jsx("div",{className:`p-4 cursor-pointer hover:bg-gray-50 transition-colors ${(a==null?void 0:a._id)===s._id?"bg-primary-50 border-r-4 border-primary-500":""}`,onClick:()=>r(s),role:"button",tabIndex:0,onKeyDown:L=>{(L.key==="Enter"||L.key===" ")&&(L.preventDefault(),r(s))},"aria-label":`Select route ${s.name} by ${s.operator}`,"aria-pressed":(a==null?void 0:a._id)===s._id,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.operator}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"w-4 h-4 text-yellow-500 mr-1","aria-hidden":"true"}),e.jsx("span",{"aria-label":`Overall rating: ${((n=(i=s.score)==null?void 0:i.overall)==null?void 0:n.toFixed(1))||"N/A"} stars`,children:((o=(c=s.score)==null?void 0:c.overall)==null?void 0:o.toFixed(1))||"N/A"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Y,{className:"w-4 h-4 text-blue-500 mr-1","aria-hidden":"true"}),e.jsxs("span",{"aria-label":`Operating hours: ${s.operatingHours.start} to ${s.operatingHours.end}`,children:[s.operatingHours.start," - ",s.operatingHours.end]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{className:"w-4 h-4 text-green-500 mr-1","aria-hidden":"true"}),e.jsx("span",{"aria-label":`Safety rating: ${((S=(N=s.score)==null?void 0:N.safety)==null?void 0:S.toFixed(1))||"N/A"} stars`,children:(($=(_=s.score)==null?void 0:_.safety)==null?void 0:$.toFixed(1))||"N/A"})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:["KES ",s.fare]}),e.jsx("div",{className:"w-4 h-4 rounded-full mt-1",style:{backgroundColor:b(s)},"aria-label":`Route quality indicator: ${b(s)}`})]})]})},s._id)})})})]}),a&&e.jsxs("div",{className:"card mt-4",role:"region","aria-labelledby":"route-details-heading",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{id:"route-details-heading",className:"text-lg font-semibold",children:"Route Details"})}),e.jsx("div",{className:"card-content",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:a.name}),e.jsx("p",{className:"text-sm text-gray-600",children:a.operator}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Real-time updates available"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-primary-600","aria-label":`Reliability score: ${((v=(g=a.score)==null?void 0:g.reliability)==null?void 0:v.toFixed(1))||"N/A"} out of 5`,children:((x=(m=a.score)==null?void 0:m.reliability)==null?void 0:x.toFixed(1))||"N/A"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Reliability"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-secondary-600","aria-label":`Safety score: ${((u=(h=a.score)==null?void 0:h.safety)==null?void 0:u.toFixed(1))||"N/A"} out of 5`,children:((A=(w=a.score)==null?void 0:w.safety)==null?void 0:A.toFixed(1))||"N/A"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Safety"})]})]}),e.jsxs("dl",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"Fare:"}),e.jsxs("dd",{className:"font-medium",children:["KES ",a.fare]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"Operating Hours:"}),e.jsxs("dd",{className:"font-medium",children:[a.operatingHours.start," - ",a.operatingHours.end]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"Stops:"}),e.jsxs("dd",{className:"font-medium",children:[a.stops.length," stops"]})]})]}),e.jsxs("button",{className:"btn btn-primary w-full","aria-label":"View selected route on map",children:[e.jsx(Z,{className:"w-4 h-4 mr-2","aria-hidden":"true"}),"View on Map"]})]})})]})]})]})})})}export{ne as default};
//# sourceMappingURL=MapView-6d1O4zUx.js.map
