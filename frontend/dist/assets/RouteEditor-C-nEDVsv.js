import{a as j,j as s}from"./index-CaOkXE30.js";import{r as l}from"./vendor-BKU87Gzz.js";import{M as te,T as ae,c as ne,a as D,L as G,u as le}from"./leaflet-C--L-ZsF.js";import{R as oe,M as O,J as ie,z as ce,$ as re,_ as de,O as ue}from"./icons-laTIaZ17.js";import"./router-Z6rqMkFf.js";function fe(){var L,P,z,U,_,I,F,T;const[x,k]=l.useState([]),[m,Q]=l.useState(""),[i,p]=l.useState([]),[q,C]=l.useState(!0),[M,R]=l.useState(!1),[v,J]=l.useState(""),[o,w]=l.useState(null),[c,d]=l.useState(null),[g,S]=l.useState(""),[A,f]=l.useState(!1),[K,h]=l.useState(null),$=e=>{const t=e.trim().match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);if(!t)return null;const a=Number(t[1]),n=Number(t[2]);return Number.isNaN(a)||Number.isNaN(n)?null:Math.abs(a)<=90&&Math.abs(n)<=180?[n,a]:[a,n]};l.useEffect(()=>{y()},[]);const y=async()=>{try{C(!0);const e=await j.getRoutes({page:1,limit:200,sort:"name",order:"asc"});e.success&&e.data?k(e.data.routes):k([])}finally{C(!1)}};l.useEffect(()=>{const e=x.find(t=>String(t._id)===String(m));if(e&&Array.isArray(e.stops)){const t=e.stops.map(a=>{var n,r;return{name:a.name||"",coordinates:[((n=a.coordinates)==null?void 0:n[0])??0,((r=a.coordinates)==null?void 0:r[1])??0]}});p(t)}else p([])},[m,x]);const Z=l.useMemo(()=>{const e=v.toLowerCase();return x.filter(t=>`${t.routeNumber||""} ${t.name}`.toLowerCase().includes(e))},[x,v]),E=(e,t)=>{const a=[...i],n=e+t;if(n<0||n>=a.length)return;const r=a[e];a[e]=a[n],a[n]=r,p(a)},u=(e,t,a)=>{p(n=>n.map((r,Y)=>{if(Y!==e)return r;if(t==="name")return{...r,name:a};const[ee,se]=r.coordinates,N=Number(a);return t==="lng"?{...r,coordinates:[isNaN(N)?0:N,se]}:{...r,coordinates:[ee,isNaN(N)?0:N]}}))},B=()=>{p(e=>[...e,{name:"New Stop",coordinates:[36.8219,-1.2921]}])},H=e=>{p(t=>t.filter((a,n)=>n!==e))},V=async()=>{if(m)try{R(!0);const e={stops:i.map(a=>({name:a.name.trim(),coordinates:a.coordinates}))};if(!(await j.updateRoute(m,e)).success)throw new Error("Failed");await y(),alert("Stops saved")}catch{alert("Failed to save")}finally{R(!1)}},b=[-1.2921,36.8219];function W({initial:e}){return ne({click(t){d([t.latlng.lng,t.latlng.lat])}}),c?s.jsx(D,{position:[c[1],c[0]],icon:G.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]})}):s.jsx(D,{position:[e[1],e[0]],icon:G.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]})})}function X({center:e}){const t=le();return l.useEffect(()=>{e&&t.flyTo([e[1],e[0]],Math.max(t.getZoom(),15))},[e,t]),null}return s.jsxs("div",{className:"min-h-screen bg-gray-50",children:[s.jsx("div",{className:"bg-white shadow-sm border-b",children:s.jsx("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8",children:s.jsxs("div",{className:"flex items-center justify-between py-6",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Route Editor"}),s.jsxs("button",{onClick:y,className:"flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:[s.jsx(oe,{className:"w-4 h-4"})," Refresh"]})]})})}),s.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow p-4 lg:col-span-1",children:[s.jsx("div",{className:"mb-3",children:s.jsx("input",{className:"form-input w-full",placeholder:"Search routes",value:v,onChange:e=>J(e.target.value)})}),s.jsx("div",{className:"max-h-[520px] overflow-auto divide-y",children:q?s.jsx("div",{className:"p-4 text-gray-500",children:"Loading routes..."}):Z.map(e=>{var t;return s.jsx("button",{className:`w-full text-left p-3 hover:bg-gray-50 ${String(e._id)===String(m)?"bg-blue-50":""}`,onClick:()=>Q(String(e._id)),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(O,{className:"w-4 h-4 text-blue-600"}),s.jsxs("div",{className:"truncate",children:[s.jsx("div",{className:"font-medium text-gray-900 truncate",children:e.routeNumber?`${e.routeNumber} - ${e.name}`:e.name}),s.jsxs("div",{className:"text-xs text-gray-500",children:[((t=e.stops)==null?void 0:t.length)||0," stops"]})]})]})},String(e._id))})})]}),s.jsx("div",{className:"bg-white rounded-lg shadow p-4 lg:col-span-2",children:m?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Stops"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:B,children:[s.jsx(ie,{className:"w-4 h-4"}),"Add Stop"]}),s.jsxs("button",{className:"btn btn-primary flex items-center gap-2",disabled:M,onClick:V,children:[s.jsx(ce,{className:"w-4 h-4"}),M?"Saving...":"Save"]})]})]}),s.jsx("div",{className:"space-y-3",children:i.map((e,t)=>s.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[s.jsx("input",{className:"form-input col-span-4",value:e.name,onChange:a=>u(t,"name",a.target.value)}),s.jsx("input",{className:"form-input col-span-3",placeholder:"Longitude",value:String(e.coordinates[0]),onChange:a=>u(t,"lng",a.target.value)}),s.jsx("input",{className:"form-input col-span-3",placeholder:"Latitude",value:String(e.coordinates[1]),onChange:a=>u(t,"lat",a.target.value)}),s.jsxs("div",{className:"col-span-2 flex justify-end gap-1",children:[s.jsx("button",{className:"btn btn-outline",onClick:()=>{w(t),d([e.coordinates[0],e.coordinates[1]])},title:"Pick on Map",children:s.jsx(O,{className:"w-4 h-4"})}),s.jsx("button",{className:"btn btn-outline",onClick:()=>E(t,-1),title:"Move up",children:s.jsx(re,{className:"w-4 h-4"})}),s.jsx("button",{className:"btn btn-outline",onClick:()=>E(t,1),title:"Move down",children:s.jsx(de,{className:"w-4 h-4"})}),s.jsx("button",{className:"btn btn-outline",onClick:()=>H(t),title:"Remove",children:s.jsx(ue,{className:"w-4 h-4 text-red-600"})})]})]},t))})]}):s.jsx("div",{className:"text-gray-500",children:"Select a route to edit its stops."})})]}),o!==null&&s.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50",children:s.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-3xl p-4",children:[s.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Click on the map to set coordinates"}),s.jsx("div",{style:{height:420},className:"rounded overflow-hidden",children:s.jsxs(te,{center:[((P=(L=i[o])==null?void 0:L.coordinates)==null?void 0:P[1])??b[0],((U=(z=i[o])==null?void 0:z.coordinates)==null?void 0:U[0])??b[1]],zoom:13,style:{height:"100%",width:"100%"},children:[s.jsx(ae,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),s.jsx(X,{center:K}),s.jsx(W,{initial:[((I=(_=i[o])==null?void 0:_.coordinates)==null?void 0:I[0])??b[1],((T=(F=i[o])==null?void 0:F.coordinates)==null?void 0:T[1])??b[0]]})]})}),s.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2 items-center",children:[s.jsxs("div",{className:"text-sm text-gray-600 md:col-span-1",children:["Picked: ",c?`${c[0].toFixed(6)}, ${c[1].toFixed(6)}`:`${i[o].coordinates[0]}, ${i[o].coordinates[1]}`]}),s.jsxs("div",{className:"flex items-center gap-2 md:col-span-1",children:[s.jsx("input",{className:"form-input w-full",placeholder:"Search place or stop name",value:g,onChange:e=>S(e.target.value),onKeyDown:async e=>{if(e.key==="Enter"){e.preventDefault(),f(!0);try{const t=$(g);if(t)h(t),d(t);else{const a=await j.geocodeAddress(g);if(a.success&&a.data){const n=[a.data.lng,a.data.lat];h(n),d(n)}}}catch{}finally{f(!1)}}}}),s.jsx("button",{className:"btn btn-outline",disabled:A,onClick:async()=>{f(!0);try{const e=$(g);if(e)h(e),d(e);else{const t=await j.geocodeAddress(g);if(t.success&&t.data){const a=[t.data.lng,t.data.lat];h(a),d(a)}}}catch{}finally{f(!1)}},children:A?"Searching…":"Search"})]}),s.jsxs("div",{className:"flex justify-end gap-2 md:col-span-1",children:[s.jsx("button",{className:"btn btn-outline",onClick:()=>{w(null),d(null),S(""),h(null)},children:"Cancel"}),s.jsx("button",{className:"btn btn-outline",disabled:!c,title:"Apply the geocoded result to this stop",onClick:()=>{if(!c)return;const e=c;u(o,"lng",String(e[0])),u(o,"lat",String(e[1]))},children:"Apply search result"}),s.jsx("button",{className:"btn btn-primary",onClick:()=>{const e=c??i[o].coordinates;u(o,"lng",String(e[0])),u(o,"lat",String(e[1])),w(null),d(null),S(""),h(null)},children:"Use pinned location"})]})]})]})})]})}export{fe as default};
//# sourceMappingURL=RouteEditor-C-nEDVsv.js.map
