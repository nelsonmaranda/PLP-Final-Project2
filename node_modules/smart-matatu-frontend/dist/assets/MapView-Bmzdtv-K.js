var Z=Object.defineProperty;var ee=(a,t,c)=>t in a?Z(a,t,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[t]=c;var J=(a,t,c)=>ee(a,typeof t!="symbol"?t+"":t,c);import{u as se,a as G,j as e,L as ae}from"./index-Darj_tO4.js";import{r as n}from"./vendor-BKU87Gzz.js";import{M as te,T as re,P as le,a as ie,b as ne,L as F,u as ce}from"./leaflet-C--L-ZsF.js";import{p as de,F as q,q as oe,l as P,h as Q,d as W,M as me}from"./icons-l6XdvyrE.js";import"./router-BF-yxxER.js";class he{constructor(){J(this,"cache",new Map)}set(t,c,p){const y=Date.now();this.cache.set(t,{data:c,timestamp:y,expiresAt:y+p})}get(t){const c=this.cache.get(t);return c?Date.now()>c.expiresAt?(this.cache.delete(t),null):c.data:null}clear(){this.cache.clear()}delete(t){this.cache.delete(t)}}const K=new he;function xe(a,t=[],c={}){const{debounceMs:p=300,cacheTime:y=5*60*1e3,retryAttempts:j=3,retryDelay:M=1e3}=c,[x,f]=n.useState(null),[E,_]=n.useState(!1),[O,T]=n.useState(null),[C,D]=n.useState(0),N=n.useRef(),b=n.useRef(),h=JSON.stringify(t),w=n.useCallback(async(z=!1)=>{const S=K.get(h);if(S&&!z){f(S);return}b.current&&b.current.abort(),b.current=new AbortController;try{_(!0),T(null);const d=await a();K.set(h,d,y),f(d),D(0)}catch(d){const I=d;if(I.name==="AbortError")return;T(I),C<j&&(D(V=>V+1),setTimeout(()=>{w(!0)},M*Math.pow(2,C)))}finally{_(!1)}},[a,h,y,j,M,C]),v=n.useCallback(()=>{N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{w()},p)},[w,p]);n.useEffect(()=>(v(),()=>{N.current&&clearTimeout(N.current),b.current&&b.current.abort()}),[v]);const H=n.useCallback(()=>{K.delete(h),w()},[h,w]),k=n.useCallback(()=>{K.clear()},[]);return{data:x,loading:E,error:O,retryCount:C,refetch:H,clearCache:k}}const X=F.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});typeof F<"u"&&F.Marker&&(F.Marker.prototype.options.icon=X);function Ne(){const{t:a}=se(),[t,c]=n.useState(null),[p,y]=n.useState(!1),[j,M]=n.useState(!1),[x,f]=n.useState({highReliability:!0,safeRoutes:!0,lowFare:!1}),[E,_]=n.useState(null),O=n.useRef(null),[T,C]=n.useState(!1);function D(){const s=ce();return E!==s&&_(s),null}const N=[-1.2921,36.8219],b=n.useCallback(async()=>{const s=await G.getRoutes({page:1,limit:50,sort:"createdAt",order:"desc"});return s.success&&s.data?s.data.routes:[]},[]),{data:h,loading:w,error:v,refetch:H}=xe(b,[x],{debounceMs:500,cacheTime:2*60*1e3,retryAttempts:2}),k=(()=>{try{return(h||[]).filter(s=>!(x.highReliability&&(!s.score||typeof s.score.reliability!="number"||s.score.reliability<4)||x.safeRoutes&&(!s.score||typeof s.score.safety!="number"||s.score.safety<4)||x.lowFare&&(typeof s.fare!="number"||s.fare>=50)))}catch(s){return console.error("Error filtering routes:",s),h||[]}})(),z=s=>s>=4.5?"#22c55e":s>=3.5?"#f59e0b":s>=2.5?"#f97316":"#ef4444",S=s=>s.score?z(s.score.overall):"#3b82f6",d=s=>!s||s._id==null?"":String(s._id),I=s=>{const r=[];if(s.path&&Array.isArray(s.path)&&s.path.length>0){for(let l=0;l<s.path.length;l+=2)if(l+1<s.path.length){const i=s.path[l+1],o=s.path[l];typeof i=="number"&&typeof o=="number"&&!isNaN(i)&&!isNaN(o)&&r.push([i,o])}}if(r.length===0&&s.stops&&Array.isArray(s.stops))for(const l of s.stops){const i=l==null?void 0:l.coordinates;Array.isArray(i)&&i.length===2&&typeof i[0]=="number"&&typeof i[1]=="number"&&r.push([i[1],i[0]])}return r},V=s=>{var l;c(s),M(!1),C(!0);const r=I(s);if(E&&r.length>0){const i=F.latLngBounds(r.map(([o,A])=>F.latLng(o,A)));E.fitBounds(i,{padding:[40,40]})}try{(l=O.current)==null||l.scrollIntoView({behavior:"smooth",block:"center"})}catch{}};return w?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ae,{}),e.jsx("p",{className:"text-gray-600 mt-4",children:a("map.loading")})]})}):v?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(de,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("p",{className:"text-red-600 mb-4",children:(v==null?void 0:v.message)||a("map.genericError")}),e.jsx("button",{onClick:H,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:a("map.tryAgain")})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"container py-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"card-title",children:a("map.title")}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{className:`btn btn-sm ${p?"btn-primary":"btn-outline"}`,onClick:()=>y(!p),"aria-label":a("map.toggleFilters"),"aria-pressed":p,children:[e.jsx(q,{className:"w-4 h-4 mr-2","aria-hidden":"true"}),a("map.filter")]}),e.jsxs("button",{className:`btn btn-sm ${j?"btn-primary":"btn-outline"}`,onClick:()=>M(!j),"aria-label":a("map.toggleListView"),"aria-pressed":j,children:[e.jsx(oe,{className:"w-4 h-4 mr-2","aria-hidden":"true"}),a("common.view")]})]})]})}),e.jsxs("div",{className:"card-content p-0",children:[p&&e.jsx("div",{className:"p-4 bg-gray-50 border-b",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{className:"h-4 w-4 text-gray-500","aria-hidden":"true"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:a("map.quickFilters")})]}),e.jsxs("fieldset",{className:"flex flex-wrap gap-4",children:[e.jsx("legend",{className:"sr-only",children:a("map.routeFilters")}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.highReliability,onChange:s=>f(r=>({...r,highReliability:s.target.checked}))}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.highReliability")})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.safeRoutes,onChange:s=>f(r=>({...r,safeRoutes:s.target.checked}))}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.safeRoutes")})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.lowFare,onChange:s=>f(r=>({...r,lowFare:s.target.checked}))}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.lowFare")})]})]})]})}),j?e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-4",children:a("map.ofRoutes").replace("{current}",String(k.length)).replace("{total}",String((h==null?void 0:h.length)||0))}),k.map(s=>{var r,l;return e.jsx("div",{className:`p-4 border rounded-lg cursor-pointer transition-colors ${d(t)===d(s)?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>c(s),children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.operator," - Route ",s.routeNumber]}),e.jsxs("div",{className:"flex items-center mt-2 space-x-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"w-3 h-3 text-yellow-500 mr-1"}),e.jsx("span",{children:((l=(r=s.score)==null?void 0:r.overall)==null?void 0:l.toFixed(1))||"N/A"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Q,{className:"w-3 h-3 text-blue-500 mr-1"}),e.jsxs("span",{children:[s.operatingHours.start," - ",s.operatingHours.end]})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:["KES ",s.fare]}),e.jsx("div",{className:"w-4 h-4 rounded-full mt-1 ml-auto",style:{backgroundColor:S(s)}})]})]})},s._id)})]})}):e.jsx("div",{ref:O,className:"map-container h-96",role:"img","aria-label":a("map.mapAria"),children:e.jsxs(te,{center:N,zoom:11,style:{height:"100%",width:"100%"},children:[e.jsx(D,{}),e.jsx(re,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),k.filter(s=>!T||d(t)===d(s)).map(s=>{try{const r=[];if(s.path&&Array.isArray(s.path)&&s.path.length>0){for(let l=0;l<s.path.length;l+=2)if(l+1<s.path.length){const i=s.path[l+1],o=s.path[l];typeof i=="number"&&typeof o=="number"&&!isNaN(i)&&!isNaN(o)&&r.push([i,o])}}return e.jsxs("div",{children:[r.length>0&&e.jsx(le,{positions:r,color:S(s),weight:d(t)===d(s)?7:4,opacity:d(t)===d(s)?.95:.3}),s.stops&&Array.isArray(s.stops)&&s.stops.map((l,i)=>{var o,A,L,$;try{const g=l.coordinates;if(!g||!Array.isArray(g)||g.length!==2)return null;const[R,m]=g;return typeof R!="number"||typeof m!="number"||isNaN(R)||isNaN(m)?null:e.jsx(ie,{position:[R,m],icon:X,children:e.jsx(ne,{children:e.jsxs("div",{className:"p-2",children:[e.jsx("h3",{className:"font-semibold",children:l.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.operator}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"h-3 w-3 mr-1 text-yellow-400"}),((A=(o=s.score)==null?void 0:o.overall)==null?void 0:A.toFixed(1))||"N/A"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"h-3 w-3 mr-1"}),(($=(L=s.score)==null?void 0:L.safety)==null?void 0:$.toFixed(1))||"N/A"]}),e.jsxs("div",{className:"text-gray-600",children:[s.fare," KES"]})]})]})})},i)}catch(g){return console.error("Error rendering stop:",g),null}})]},s._id)}catch(r){return console.error("Error rendering route:",r),null}})]})})]})]})}),e.jsx("div",{className:"w-full lg:w-80",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a("map.availableRoutes")}),e.jsx("p",{className:"text-sm text-gray-600",children:a("map.ofRoutes").replace("{current}",String(k.length)).replace("{total}",String((h==null?void 0:h.length)||0))})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{className:"h-4 w-4 text-gray-500","aria-hidden":"true"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Filters"})]}),e.jsxs("fieldset",{className:"space-y-2",children:[e.jsx("legend",{className:"sr-only",children:a("map.routeFilters")}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.highReliability,onChange:s=>f(r=>({...r,highReliability:s.target.checked})),"aria-describedby":"high-reliability-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.highReliability")})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.safeRoutes,onChange:s=>f(r=>({...r,safeRoutes:s.target.checked})),"aria-describedby":"safe-routes-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.safeRoutes")})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:x.lowFare,onChange:s=>f(r=>({...r,lowFare:s.target.checked})),"aria-describedby":"low-fare-desc"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:a("map.lowFare")})]})]})]})}),e.jsx("div",{className:"card-content p-0",children:e.jsx("div",{className:"divide-y divide-gray-200",children:k.map(s=>{var r,l,i,o,A,L,$,g,R;return e.jsxs("div",{className:`p-4 cursor-pointer hover:bg-gray-50 transition-colors ${(t==null?void 0:t._id)===s._id?"bg-primary-50 border-r-4 border-primary-500":""}`,onClick:()=>c(s),role:"button",tabIndex:0,onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),c(s))},"aria-label":`Select route ${s.name} by ${s.operator}`,"aria-pressed":(t==null?void 0:t._id)===s._id,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.operator}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"w-4 h-4 text-yellow-500 mr-1","aria-hidden":"true"}),e.jsx("span",{"aria-label":`Overall rating: ${((l=(r=s.score)==null?void 0:r.overall)==null?void 0:l.toFixed(1))||"N/A"} stars`,children:((o=(i=s.score)==null?void 0:i.overall)==null?void 0:o.toFixed(1))||"N/A"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Q,{className:"w-4 h-4 text-blue-500 mr-1","aria-hidden":"true"}),e.jsxs("span",{"aria-label":`Operating hours: ${s.operatingHours.start} to ${s.operatingHours.end}`,children:[s.operatingHours.start," - ",s.operatingHours.end]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"w-4 h-4 text-green-500 mr-1","aria-hidden":"true"}),e.jsx("span",{"aria-label":`Safety rating: ${((L=(A=s.score)==null?void 0:A.safety)==null?void 0:L.toFixed(1))||"N/A"} stars`,children:((g=($=s.score)==null?void 0:$.safety)==null?void 0:g.toFixed(1))||"N/A"})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:["KES ",s.fare]}),e.jsx("div",{className:"w-4 h-4 rounded-full mt-1",style:{backgroundColor:S(s)},"aria-label":`Route quality indicator: ${S(s)}`})]})]}),d(t)===d(s)&&e.jsxs("div",{className:"mt-3 pt-3 border-t",children:[e.jsxs("dl",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:a("map.fare")}),e.jsxs("dd",{className:"font-medium",children:["KES ",s.fare]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:a("map.hours")}),e.jsxs("dd",{className:"font-medium",children:[s.operatingHours.start," - ",s.operatingHours.end]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:a("map.stops")}),e.jsx("dd",{className:"font-medium",children:((R=s.stops)==null?void 0:R.length)||0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:a("map.routeNo")}),e.jsx("dd",{className:"font-medium",children:s.routeNumber||"—"})]})]}),e.jsxs("div",{className:"mt-3 flex gap-2 items-center flex-wrap",children:[e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:m=>{m.stopPropagation(),V(s)},children:[e.jsx(me,{className:"w-4 h-4 mr-1"})," ",a("map.viewOnMap")]}),e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(m=>{var U;return e.jsx("button",{className:"p-1",title:`${a("map.rate")} ${m}`,onClick:async Y=>{Y.stopPropagation();try{await G.rateRoute(s._id,{overall:m}),c(u=>{var B;return u&&u._id===s._id?{...u,score:{...u.score||{},overall:((((B=u.score)==null?void 0:B.overall)||0)+m)/2}}:u}),H()}catch(u){console.error("Rating failed",u),alert("Failed to submit rating")}},children:e.jsx(P,{className:`w-5 h-5 ${Number((U=t==null?void 0:t.score)==null?void 0:U.overall)>=m?"text-yellow-500":"text-gray-300"}`})},m)})})]})]})]},s._id)})})})]})})]})})})}export{Ne as default};
//# sourceMappingURL=MapView-Bmzdtv-K.js.map
